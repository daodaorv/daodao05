# å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´å®ç°æŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ
2025-12-12

## å®ç°æ¦‚è¿°

æ ¹æ®å¾®ä¿¡å®˜æ–¹æœ€æ–°æ”¿ç­–ï¼ˆ2023å¹´åï¼‰ï¼Œå·²å®Œæ•´å®ç°å¾®ä¿¡å°ç¨‹åºçš„ç”¨æˆ·ä¿¡æ¯è·å–åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… **æ‰‹æœºå·è·å–**ï¼šé€šè¿‡ `open-type="getPhoneNumber"` å®ç°
- âœ… **å¤´åƒè·å–**ï¼šé€šè¿‡ `open-type="chooseAvatar"` è®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©
- âœ… **æ˜µç§°è·å–**ï¼šé€šè¿‡ `<input type="nickname">` è®©ç”¨æˆ·ä¸»åŠ¨è¾“å…¥

---

## é‡è¦æ”¿ç­–è¯´æ˜

### å¾®ä¿¡å®˜æ–¹æ”¿ç­–å˜æ›´

**2023å¹´èµ·ï¼Œå¾®ä¿¡å°ç¨‹åºå·²å®Œå…¨åºŸå¼ƒä»¥ä¸‹æ¥å£ï¼š**
- âŒ `wx.getUserProfile()` - å·²åºŸå¼ƒ
- âŒ `wx.getUserInfo()` - å·²åºŸå¼ƒ
- âŒ æ— æ³•é€šè¿‡ä»»ä½•æ¥å£ç›´æ¥è·å–ç”¨æˆ·çš„å¾®ä¿¡å¤´åƒå’Œæ˜µç§°

**æ–°çš„è·å–æ–¹å¼ï¼š**
1. **æ‰‹æœºå·**ï¼šä½¿ç”¨ `<button open-type="getPhoneNumber">` è·å–åŠ å¯†æ•°æ®ï¼Œåç«¯è§£å¯†
2. **å¤´åƒ**ï¼šä½¿ç”¨ `<button open-type="chooseAvatar">` è®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©å¤´åƒ
3. **æ˜µç§°**ï¼šä½¿ç”¨ `<input type="nickname">` è®©ç”¨æˆ·ä¸»åŠ¨è¾“å…¥æ˜µç§°

è¿™æ˜¯å¾®ä¿¡å®˜æ–¹ä¸ºäº†ä¿æŠ¤ç”¨æˆ·éšç§è€Œåšå‡ºçš„å¼ºåˆ¶æ€§å˜æ›´ï¼Œæ‰€æœ‰å°ç¨‹åºå¿…é¡»éµå®ˆã€‚

---

## å®Œæ•´å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"
         â†“
è§¦å‘ open-type="getPhoneNumber"
         â†“
ç”¨æˆ·æˆæƒæ‰‹æœºå·
         â†“
è·å–åŠ å¯†æ•°æ®ï¼ˆencryptedData + ivï¼‰
         â†“
è°ƒç”¨ uni.login è·å– code
         â†“
å‘é€åˆ°åç«¯ï¼šcode + encryptedData + iv
         â†“
åç«¯è§£å¯†è·å–æ‰‹æœºå·
         â†“
è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
         â†“
æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´
         â†“
â”œâ”€ ç¼ºå°‘å¤´åƒ/æ˜µç§° â†’ è·³è½¬åˆ°å®Œå–„ä¿¡æ¯é¡µé¢
â”‚                   â†“
â”‚              ç”¨æˆ·é€‰æ‹©å¤´åƒï¼ˆopen-type="chooseAvatar"ï¼‰
â”‚                   â†“
â”‚              ç”¨æˆ·è¾“å…¥æ˜µç§°ï¼ˆtype="nickname"ï¼‰
â”‚                   â†“
â”‚              ä¿å­˜å¹¶è·³è½¬é¦–é¡µ
â”‚
â””â”€ ä¿¡æ¯å®Œæ•´ â†’ ç›´æ¥è·³è½¬é¦–é¡µ
```

---

## ä»£ç å®ç°è¯¦è§£

### 1. ç™»å½•é¡µé¢ - æ‰‹æœºå·æˆæƒ

**æ–‡ä»¶ï¼š** `miniprogram/pages/auth/login.vue`

#### 1.1 ç™»å½•æŒ‰é’®ï¼ˆä½¿ç”¨ open-typeï¼‰

```vue
<!-- å¾®ä¿¡å°ç¨‹åºä½¿ç”¨ open-type è·å–æ‰‹æœºå· -->
<button
  v-if="platform === 'weixin'"
  class="oneclick-btn"
  open-type="getPhoneNumber"
  @getphonenumber="handleWechatPhoneNumber"
>
  <image class="platform-icon" :src="platformIcon" mode="aspectFit" />
  <text class="btn-text">å¾®ä¿¡ä¸€é”®ç™»å½•</text>
</button>
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `open-type="getPhoneNumber"` è§¦å‘æ‰‹æœºå·æˆæƒ
- ç»‘å®š `@getphonenumber` äº‹ä»¶å¤„ç†å›è°ƒ
- åªåœ¨å¾®ä¿¡å°ç¨‹åºå¹³å°æ˜¾ç¤º

#### 1.2 æ‰‹æœºå·æˆæƒå›è°ƒå¤„ç†

```typescript
// å¾®ä¿¡æ‰‹æœºå·æˆæƒå›è°ƒ
const handleWechatPhoneNumber = async (e: any) => {
  console.log('[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] å›è°ƒäº‹ä»¶:', e)

  // æ£€æŸ¥ç”¨æˆ·åè®®
  if (!agreed.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·æ‹’ç»æˆæƒ
  if (e.detail.errMsg && e.detail.errMsg.indexOf('fail') !== -1) {
    uni.showToast({
      title: 'æ‚¨æ‹’ç»äº†æˆæƒï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹å¼ç™»å½•',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·åŒæ„æˆæƒ
  if (e.detail.code) {
    loading.value = true

    // è°ƒç”¨ uni.login è·å–ç™»å½•å‡­è¯
    uni.login({
      provider: 'weixin',
      success: async (loginRes) => {
        try {
          // è°ƒç”¨åç«¯APIï¼Œä¼ é€’åŠ å¯†æ•°æ®
          const result = await wechatLogin({
            code: loginRes.code,
            encryptedData: e.detail.encryptedData,
            iv: e.detail.iv
          })

          // ä¿å­˜ç™»å½•ä¿¡æ¯
          saveLoginInfo(result.token, result.refreshToken, result.user)

          // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´ï¼ˆå¤´åƒå’Œæ˜µç§°ï¼‰
          const needCompleteInfo = !result.user.nickname || !result.user.avatar

          if (needCompleteInfo) {
            // è·³è½¬åˆ°å®Œå–„ä¿¡æ¯é¡µé¢
            uni.redirectTo({
              url: '/pages/profile/complete-info?from=login'
            })
          } else {
            // ç›´æ¥è·³è½¬é¦–é¡µ
            handleLoginSuccess()
          }
        } catch (error: any) {
          uni.showToast({
            title: error.message || 'ç™»å½•å¤±è´¥',
            icon: 'none'
          })
        } finally {
          loading.value = false
        }
      }
    })
  }
}
```

**å…³é”®ç‚¹ï¼š**
1. è·å– `e.detail.code`ã€`e.detail.encryptedData`ã€`e.detail.iv`
2. è°ƒç”¨ `uni.login` è·å–ç™»å½•å‡­è¯ `code`
3. å°†æ‰€æœ‰æ•°æ®å‘é€ç»™åç«¯
4. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´ï¼Œå†³å®šæ˜¯å¦è·³è½¬åˆ°å®Œå–„ä¿¡æ¯é¡µé¢

---

### 2. å®Œå–„ä¿¡æ¯é¡µé¢ - å¤´åƒå’Œæ˜µç§°

**æ–‡ä»¶ï¼š** `miniprogram/pages/profile/complete-info.vue`

#### 2.1 å¤´åƒé€‰æ‹©ï¼ˆä½¿ç”¨ open-type="chooseAvatar"ï¼‰

```vue
<template>
  <view class="avatar-wrapper">
    <!-- å¾®ä¿¡å°ç¨‹åºä½¿ç”¨ open-type="chooseAvatar" -->
    <button
      class="avatar-btn"
      open-type="chooseAvatar"
      @chooseavatar="handleChooseAvatar"
    >
      <image
        class="avatar-image"
        :src="userInfo.avatar || '/static/default-avatar.png'"
        mode="aspectFill"
      />
      <view class="avatar-mask">
        <u-icon name="camera" size="32" color="#FFFFFF" />
        <text class="mask-text">ç‚¹å‡»æ›´æ¢</text>
      </view>
    </button>
  </view>
</template>

<script setup lang="ts">
// é€‰æ‹©å¤´åƒå›è°ƒ
const handleChooseAvatar = (e: any) => {
  console.log('[é€‰æ‹©å¤´åƒ] å›è°ƒäº‹ä»¶:', e)

  if (e.detail.avatarUrl) {
    // ä¸´æ—¶æ˜¾ç¤ºå¤´åƒ
    userInfo.value.avatar = e.detail.avatarUrl

    // ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨
    uploadAvatar(e.detail.avatarUrl)
  }
}

// ä¸Šä¼ å¤´åƒ
const uploadAvatar = (tempFilePath: string) => {
  uni.showLoading({
    title: 'ä¸Šä¼ ä¸­...',
    mask: true
  })

  uni.uploadFile({
    url: 'https://your-api.com/upload/avatar',
    filePath: tempFilePath,
    name: 'file',
    header: {
      'Authorization': `Bearer ${uni.getStorageSync('token')}`
    },
    success: (uploadRes) => {
      const data = JSON.parse(uploadRes.data)
      userInfo.value.avatar = data.url
      uni.showToast({
        title: 'å¤´åƒä¸Šä¼ æˆåŠŸ',
        icon: 'success'
      })
    },
    fail: (err) => {
      uni.showToast({
        title: 'ä¸Šä¼ å¤±è´¥',
        icon: 'none'
      })
      userInfo.value.avatar = ''
    },
    complete: () => {
      uni.hideLoading()
    }
  })
}
</script>
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `open-type="chooseAvatar"` è§¦å‘å¤´åƒé€‰æ‹©
- è·å– `e.detail.avatarUrl` ä¸´æ—¶æ–‡ä»¶è·¯å¾„
- ä½¿ç”¨ `uni.uploadFile` ä¸Šä¼ åˆ°æœåŠ¡å™¨
- ä¿å­˜æœåŠ¡å™¨è¿”å›çš„æ°¸ä¹… URL

#### 2.2 æ˜µç§°è¾“å…¥ï¼ˆä½¿ç”¨ type="nickname"ï¼‰

```vue
<template>
  <view class="nickname-wrapper">
    <!-- å¾®ä¿¡å°ç¨‹åºä½¿ç”¨ type="nickname" -->
    <input
      type="nickname"
      class="nickname-input"
      v-model="userInfo.nickname"
      placeholder="è¯·è¾“å…¥æ˜µç§°"
      maxlength="20"
      @blur="handleNicknameBlur"
    />
  </view>
</template>

<script setup lang="ts">
// æ˜µç§°è¾“å…¥å¤±ç„¦
const handleNicknameBlur = (e: any) => {
  console.log('[æ˜µç§°è¾“å…¥] å€¼:', e.detail.value)
  userInfo.value.nickname = e.detail.value.trim()
}
</script>
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `type="nickname"` è§¦å‘æ˜µç§°è¾“å…¥
- å¾®ä¿¡ä¼šè‡ªåŠ¨æä¾›æ˜µç§°å»ºè®®
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹æˆ–è‡ªå®šä¹‰æ˜µç§°

#### 2.3 ä¿å­˜ç”¨æˆ·ä¿¡æ¯

```typescript
// ä¿å­˜
const handleSave = async () => {
  // éªŒè¯
  if (userInfo.value.nickname.trim().length < 2) {
    uni.showToast({
      title: 'æ˜µç§°è‡³å°‘2ä¸ªå­—ç¬¦',
      icon: 'none'
    })
    return
  }

  if (!userInfo.value.avatar) {
    uni.showToast({
      title: 'è¯·é€‰æ‹©å¤´åƒ',
      icon: 'none'
    })
    return
  }

  try {
    loading.value = true

    // è°ƒç”¨æ›´æ–°ç”¨æˆ·èµ„æ–™æ¥å£
    const result = await updateUserProfile({
      nickname: userInfo.value.nickname,
      avatar: userInfo.value.avatar,
      gender: userInfo.value.gender
    })

    // æ›´æ–°æœ¬åœ°ç¼“å­˜
    const cachedUserInfo = uni.getStorageSync('userInfo')
    const updatedUserInfo = {
      ...cachedUserInfo,
      nickname: userInfo.value.nickname,
      avatar: userInfo.value.avatar,
      gender: userInfo.value.gender
    }
    uni.setStorageSync('userInfo', updatedUserInfo)

    uni.showToast({
      title: 'ä¿å­˜æˆåŠŸ',
      icon: 'success'
    })

    // è·³è½¬åˆ°é¦–é¡µ
    setTimeout(() => {
      uni.switchTab({
        url: '/pages/index/index'
      })
    }, 1500)
  } catch (error: any) {
    uni.showToast({
      title: error.message || 'ä¿å­˜å¤±è´¥',
      icon: 'none'
    })
  } finally {
    loading.value = false
  }
}
```

---

## API æ¥å£è¯´æ˜

### å‰ç«¯ API

**æ–‡ä»¶ï¼š** `miniprogram/api/auth.ts`

```typescript
// å¾®ä¿¡ç™»å½•å‚æ•°
export interface WechatLoginParams {
  code: string              // å¾®ä¿¡ç™»å½•å‡­è¯ï¼ˆå¿…å¡«ï¼‰
  encryptedData?: string    // æ‰‹æœºå·åŠ å¯†æ•°æ®ï¼ˆå¯é€‰ï¼‰
  iv?: string               // åŠ å¯†ç®—æ³•åˆå§‹å‘é‡ï¼ˆå¯é€‰ï¼‰
}

// å¾®ä¿¡ç™»å½•
export function wechatLogin(params: WechatLoginParams): Promise<LoginResponse>

// æ›´æ–°ç”¨æˆ·èµ„æ–™
export function updateUserProfile(data: Partial<UserInfo>): Promise<UserInfo>
```

### åç«¯ APIï¼ˆå¾…å¼€å‘ï¼‰

#### 1. å¾®ä¿¡ç™»å½•æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /api/auth/wechat/login`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "code": "081xYz000Ey8Ks1234567890",
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZM...",
  "iv": "r7BXXKkLb8qrSNn05n0qiA=="
}
```

**å¤„ç†æµç¨‹ï¼š**
1. ä½¿ç”¨ `code` è°ƒç”¨å¾®ä¿¡æ¥å£æ¢å– `session_key` å’Œ `openid`
2. ä½¿ç”¨ `session_key`ã€`encryptedData`ã€`iv` è§£å¯†è·å–æ‰‹æœºå·
3. æ ¹æ® `openid` æˆ–æ‰‹æœºå·æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·
4. ç”Ÿæˆ JWT token è¿”å›

**å“åº”æ•°æ®ï¼š**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "user_001",
    "phone": "13800138000",
    "nickname": "",           // åˆæ¬¡ç™»å½•ä¸ºç©º
    "avatar": "",             // åˆæ¬¡ç™»å½•ä¸ºç©º
    "openid": "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o",
    "userType": "NORMAL",
    "status": "ACTIVE"
  }
}
```

#### 2. æ›´æ–°ç”¨æˆ·èµ„æ–™æ¥å£

**æ¥å£è·¯å¾„ï¼š** `PUT /api/user/profile`

**è¯·æ±‚å¤´ï¼š**
```
Authorization: Bearer {token}
```

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "nickname": "å¨å¨ç”¨æˆ·",
  "avatar": "https://cdn.example.com/avatar/xxx.jpg",
  "gender": 1
}
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "id": "user_001",
  "phone": "13800138000",
  "nickname": "å¨å¨ç”¨æˆ·",
  "avatar": "https://cdn.example.com/avatar/xxx.jpg",
  "gender": 1,
  "userType": "NORMAL",
  "status": "ACTIVE"
}
```

#### 3. å¤´åƒä¸Šä¼ æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /api/upload/avatar`

**è¯·æ±‚å¤´ï¼š**
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°ï¼š**
```
file: (binary)
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "url": "https://cdn.example.com/avatar/xxx.jpg"
}
```

---

## æ–‡ä»¶å˜æ›´æ€»ç»“

### æ–°å¢æ–‡ä»¶

1. **[miniprogram/pages/profile/complete-info.vue](../pages/profile/complete-info.vue)**
   - ç”¨æˆ·ä¿¡æ¯å®Œå–„é¡µé¢
   - å®ç°å¤´åƒé€‰æ‹©å’Œæ˜µç§°è¾“å…¥
   - çº¦ 400 è¡Œä»£ç 

2. **[miniprogram/docs/å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´å®ç°æŠ¥å‘Š.md](./å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´å®ç°æŠ¥å‘Š.md)**
   - å®Œæ•´çš„å®ç°æ–‡æ¡£
   - åŒ…å«ä»£ç ç¤ºä¾‹å’Œ API è¯´æ˜

### ä¿®æ”¹æ–‡ä»¶

1. **[miniprogram/pages/auth/login.vue](../pages/auth/login.vue)**
   - ä¿®æ”¹ç™»å½•æŒ‰é’®ä¸º `open-type="getPhoneNumber"`
   - æ–°å¢ `handleWechatPhoneNumber` å›è°ƒå‡½æ•°
   - æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œæ•´æ€§æ£€æŸ¥é€»è¾‘
   - ä¿®æ”¹çº¦ 100 è¡Œä»£ç 

2. **[miniprogram/pages.json](../pages.json)**
   - æ·»åŠ å®Œå–„ä¿¡æ¯é¡µé¢é…ç½®
   - æ–°å¢ 1 ä¸ªé¡µé¢è·¯ç”±

---

## æµ‹è¯•æŒ‡å—

### 1. å¾®ä¿¡å¼€å‘è€…å·¥å…·æµ‹è¯•

#### æµ‹è¯•æ­¥éª¤ï¼š

1. **æµ‹è¯•æ‰‹æœºå·æˆæƒ**
   ```
   1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
   2. è¿è¡Œå°ç¨‹åº
   3. ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
   4. åœ¨å¼¹å‡ºçš„æˆæƒçª—å£ä¸­ç‚¹å‡»"å…è®¸"
   5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
   ```

   **é¢„æœŸæ—¥å¿—ï¼š**
   ```
   [å¾®ä¿¡æ‰‹æœºå·æˆæƒ] å›è°ƒäº‹ä»¶: { detail: { code: "xxx", encryptedData: "xxx", iv: "xxx" } }
   [å¾®ä¿¡ç™»å½•] è·å–codeæˆåŠŸ: 081xYz000Ey8Ks1234567890
   [å¾®ä¿¡æ‰‹æœºå·] è·å–æ‰‹æœºå·codeæˆåŠŸ: xxx
   [Mock] å¾®ä¿¡æˆæƒç™»å½•: { code: "xxx", encryptedData: "xxx", iv: "xxx" }
   [å¾®ä¿¡ç™»å½•] éœ€è¦å®Œå–„ç”¨æˆ·ä¿¡æ¯
   ```

2. **æµ‹è¯•å¤´åƒé€‰æ‹©**
   ```
   1. ç™»å½•æˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°å®Œå–„ä¿¡æ¯é¡µé¢
   2. ç‚¹å‡»å¤´åƒåŒºåŸŸ
   3. åœ¨å¼¹å‡ºçš„ç›¸å†Œä¸­é€‰æ‹©ä¸€å¼ å›¾ç‰‡
   4. æŸ¥çœ‹å¤´åƒæ˜¯å¦æ˜¾ç¤º
   5. æŸ¥çœ‹æ§åˆ¶å°ä¸Šä¼ æ—¥å¿—
   ```

   **é¢„æœŸæ—¥å¿—ï¼š**
   ```
   [é€‰æ‹©å¤´åƒ] å›è°ƒäº‹ä»¶: { detail: { avatarUrl: "wxfile://tmp_xxx.jpg" } }
   [ä¸Šä¼ å¤´åƒ] æˆåŠŸ: https://cdn.example.com/avatar/xxx.jpg
   ```

3. **æµ‹è¯•æ˜µç§°è¾“å…¥**
   ```
   1. ç‚¹å‡»æ˜µç§°è¾“å…¥æ¡†
   2. è¾“å…¥æ˜µç§°ï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰
   3. ç‚¹å‡»ä¿å­˜æŒ‰é’®
   4. æŸ¥çœ‹æ˜¯å¦ä¿å­˜æˆåŠŸå¹¶è·³è½¬
   ```

   **é¢„æœŸç»“æœï¼š**
   ```
   - æ˜¾ç¤º"ä¿å­˜æˆåŠŸ"æç¤º
   - 1.5ç§’åè·³è½¬åˆ°é¦–é¡µ
   - ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°
   ```

### 2. çœŸæœºæµ‹è¯•ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰

#### å‰ç½®æ¡ä»¶ï¼š

1. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®å°ç¨‹åºä¿¡æ¯
2. é…ç½®æœåŠ¡å™¨åŸŸåç™½åå•
3. åç«¯æ¥å£å·²éƒ¨ç½²å¹¶å¯è®¿é—®

#### æµ‹è¯•æ­¥éª¤ï¼š

1. ä½¿ç”¨å¾®ä¿¡æ‰«ç é¢„è§ˆå°ç¨‹åº
2. å®Œæ•´èµ°ä¸€éç™»å½•æµç¨‹
3. éªŒè¯æ‰‹æœºå·æ˜¯å¦æ­£ç¡®è·å–
4. éªŒè¯å¤´åƒä¸Šä¼ æ˜¯å¦æˆåŠŸ
5. éªŒè¯æ˜µç§°ä¿å­˜æ˜¯å¦æˆåŠŸ
6. éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥è·å–å¾®ä¿¡å¤´åƒå’Œæ˜µç§°ï¼Ÿ

**A:** è¿™æ˜¯å¾®ä¿¡å®˜æ–¹çš„å¼ºåˆ¶æ€§æ”¿ç­–å˜æ›´ï¼ˆ2023å¹´èµ·ï¼‰ã€‚å¾®ä¿¡ä¸ºäº†ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œå·²ç»å®Œå…¨åºŸå¼ƒäº† `getUserProfile` å’Œ `getUserInfo` æ¥å£ã€‚æ‰€æœ‰å°ç¨‹åºå¿…é¡»éµå®ˆæ–°è§„èŒƒï¼Œè®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©å¤´åƒå’Œè¾“å…¥æ˜µç§°ã€‚

### Q2: ç”¨æˆ·æ‹’ç»æˆæƒæ‰‹æœºå·æ€ä¹ˆåŠï¼Ÿ

**A:** æä¾›å…¶ä»–ç™»å½•æ–¹å¼ä½œä¸ºå¤‡é€‰ï¼š
- æ‰‹æœºå· + éªŒè¯ç ç™»å½•
- æ‰‹æœºå· + å¯†ç ç™»å½•
- ç”¨æˆ·å + å¯†ç ç™»å½•

### Q3: ç”¨æˆ·è·³è¿‡å®Œå–„ä¿¡æ¯æ€ä¹ˆåŠï¼Ÿ

**A:** åœ¨å®Œå–„ä¿¡æ¯é¡µé¢æä¾›"è·³è¿‡"æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥ç¨ååœ¨ä¸ªäººä¸­å¿ƒå®Œå–„ä¿¡æ¯ã€‚ä½†å»ºè®®åœ¨å…³é”®æ“ä½œï¼ˆå¦‚ä¸‹å•ï¼‰æ—¶å†æ¬¡æé†’ç”¨æˆ·å®Œå–„ä¿¡æ¯ã€‚

### Q4: å¤´åƒä¸Šä¼ å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:**
1. æ£€æŸ¥ä¸Šä¼ æ¥å£æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æœåŠ¡å™¨åŸŸåæ˜¯å¦åœ¨ç™½åå•ä¸­
3. æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
4. æä¾›é‡è¯•æœºåˆ¶
5. æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

### Q5: åç«¯å¦‚ä½•è§£å¯†æ‰‹æœºå·ï¼Ÿ

**A:** ä½¿ç”¨å¾®ä¿¡æä¾›çš„è§£å¯†ç®—æ³•ï¼š

```javascript
const crypto = require('crypto')

function decryptData(encryptedData, iv, sessionKey) {
  const sessionKeyBuffer = Buffer.from(sessionKey, 'base64')
  const encryptedDataBuffer = Buffer.from(encryptedData, 'base64')
  const ivBuffer = Buffer.from(iv, 'base64')

  const decipher = crypto.createDecipheriv('aes-128-cbc', sessionKeyBuffer, ivBuffer)
  decipher.setAutoPadding(true)

  let decoded = decipher.update(encryptedDataBuffer, null, 'utf8')
  decoded += decipher.final('utf8')

  return JSON.parse(decoded)
}

// ä½¿ç”¨ç¤ºä¾‹
const phoneData = decryptData(encryptedData, iv, session_key)
console.log('æ‰‹æœºå·:', phoneData.phoneNumber)
```

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å¤´åƒè£å‰ªåŠŸèƒ½

```typescript
// ä½¿ç”¨ uni.chooseImage é€‰æ‹©å›¾ç‰‡åè¿›è¡Œè£å‰ª
uni.chooseImage({
  count: 1,
  sizeType: ['compressed'],
  sourceType: ['album', 'camera'],
  success: (res) => {
    // è·³è½¬åˆ°è£å‰ªé¡µé¢
    uni.navigateTo({
      url: `/pages/crop/index?image=${res.tempFilePaths[0]}`
    })
  }
})
```

### 2. æ·»åŠ æ˜µç§°æ•æ„Ÿè¯è¿‡æ»¤

```typescript
// åç«¯éªŒè¯æ˜µç§°
function validateNickname(nickname: string): boolean {
  const sensitiveWords = ['æ•æ„Ÿè¯1', 'æ•æ„Ÿè¯2']
  return !sensitiveWords.some(word => nickname.includes(word))
}
```

### 3. æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œå–„è¿›åº¦æç¤º

```vue
<view class="progress-tip">
  <text>å®Œæˆåº¦ï¼š{{ completionRate }}%</text>
  <progress :percent="completionRate" stroke-width="4" />
</view>
```

### 4. æ·»åŠ å¤´åƒç¼“å­˜æœºåˆ¶

```typescript
// ç¼“å­˜å¤´åƒåˆ°æœ¬åœ°
uni.saveFile({
  tempFilePath: avatarUrl,
  success: (res) => {
    uni.setStorageSync('cachedAvatar', res.savedFilePath)
  }
})
```

---

## å‚è€ƒæ–‡æ¡£

### å®˜æ–¹æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºç™»å½•](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [å¾®ä¿¡å°ç¨‹åºè·å–æ‰‹æœºå·](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [å¾®ä¿¡å°ç¨‹åºå¤´åƒæ˜µç§°å¡«å†™](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)
- [uni-app uni.login API](https://uniapp.dcloud.net.cn/api/plugins/login.html)
- [uni-app button ç»„ä»¶](https://uniapp.dcloud.net.cn/component/button.html)

### é¡¹ç›®æ–‡æ¡£

- [å°ç¨‹åºç«¯ API æ–‡æ¡£](./å°ç¨‹åºç«¯API.md)
- [ä¸€é”®ç™»å½•ä¿®å¤æŠ¥å‘Š](./ä¸€é”®ç™»å½•ä¿®å¤æŠ¥å‘Š.md)
- [å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´æ–¹æ¡ˆ](./å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´æ–¹æ¡ˆ.md)

---

## å®ç°å®Œæˆç¡®è®¤

### å‰ç«¯å®ç° âœ…

- âœ… æ‰‹æœºå·æˆæƒåŠŸèƒ½å·²å®ç°
- âœ… å¤´åƒé€‰æ‹©åŠŸèƒ½å·²å®ç°
- âœ… æ˜µç§°è¾“å…¥åŠŸèƒ½å·²å®ç°
- âœ… ç”¨æˆ·ä¿¡æ¯å®Œå–„é¡µé¢å·²åˆ›å»º
- âœ… ç™»å½•æµç¨‹å·²å®Œå–„
- âœ… é”™è¯¯å¤„ç†å·²å®Œå–„
- âœ… æ—¥å¿—è¾“å‡ºå·²å®Œå–„
- âœ… é¡µé¢è·¯ç”±å·²é…ç½®

### åç«¯å®ç° â³

- â³ æ‰‹æœºå·è§£å¯†æ¥å£å¾…å¼€å‘
- â³ ç”¨æˆ·èµ„æ–™æ›´æ–°æ¥å£å¾…å¼€å‘
- â³ å¤´åƒä¸Šä¼ æ¥å£å¾…å¼€å‘

### æµ‹è¯• â³

- â³ å¾®ä¿¡å¼€å‘è€…å·¥å…·æµ‹è¯•å¾…è¿›è¡Œ
- â³ çœŸæœºæµ‹è¯•å¾…è¿›è¡Œ
- â³ ç«¯åˆ°ç«¯æµ‹è¯•å¾…è¿›è¡Œ

---

## æ€»ç»“

æœ¬æ¬¡å®ç°å®Œå…¨éµå¾ªå¾®ä¿¡å®˜æ–¹æœ€æ–°è§„èŒƒï¼Œå®ç°äº†ï¼š

1. **æ‰‹æœºå·è·å–**ï¼šé€šè¿‡ `open-type="getPhoneNumber"` è·å–åŠ å¯†æ•°æ®ï¼Œåç«¯è§£å¯†
2. **å¤´åƒè·å–**ï¼šé€šè¿‡ `open-type="chooseAvatar"` è®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©å¤´åƒ
3. **æ˜µç§°è·å–**ï¼šé€šè¿‡ `<input type="nickname">` è®©ç”¨æˆ·ä¸»åŠ¨è¾“å…¥æ˜µç§°

è¿™æ˜¯ç›®å‰å¾®ä¿¡å°ç¨‹åºè·å–ç”¨æˆ·ä¿¡æ¯çš„**å”¯ä¸€åˆè§„æ–¹å¼**ï¼Œæ‰€æœ‰ä»£ç å‡ç¬¦åˆå¾®ä¿¡å®˜æ–¹è§„èŒƒï¼Œå¯ä»¥æ­£å¸¸é€šè¿‡å®¡æ ¸ã€‚

**ä¿®å¤çŠ¶æ€ï¼š** ğŸŸ¢ å‰ç«¯å·²å®Œæˆï¼Œç­‰å¾…åç«¯å¯¹æ¥å’Œæµ‹è¯•

**å»ºè®®ï¼š**
1. å°½å¿«å¼€å‘åç«¯æ‰‹æœºå·è§£å¯†æ¥å£
2. å¼€å‘å¤´åƒä¸Šä¼ å’Œç”¨æˆ·èµ„æ–™æ›´æ–°æ¥å£
3. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿›è¡Œå®Œæ•´æµ‹è¯•
4. è¿›è¡ŒçœŸæœºæµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹
