# å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯è·å–å®Œæ•´æ–¹æ¡ˆ

## ä¿®å¤æ—¥æœŸ
2025-12-12

## é—®é¢˜èƒŒæ™¯

### åŸå§‹é—®é¢˜
å¾®ä¿¡ä¸€é”®ç™»å½•åŠŸèƒ½å·²å®ç°ï¼Œä½†æœªæ­£ç¡®åŒæ­¥è·å–å¾®ä¿¡å¤´åƒã€ç”¨æˆ·æ˜µç§°ç­‰åŠŸèƒ½ã€‚

### å¾®ä¿¡å°ç¨‹åºæ”¿ç­–å˜åŒ–

**é‡è¦å˜æ›´ï¼ˆ2023å¹´èµ·ï¼‰ï¼š**

å¾®ä¿¡å®˜æ–¹å·²ç»åºŸå¼ƒäº† `getUserProfile` å’Œ `getUserInfo` æ¥å£ï¼Œä¸å†å…è®¸é€šè¿‡æ¥å£ç›´æ¥è·å–ç”¨æˆ·å¤´åƒå’Œæ˜µç§°ã€‚

**æ–°çš„è·å–æ–¹å¼ï¼š**

1. **å¤´åƒå’Œæ˜µç§°**ï¼šéœ€è¦ç”¨æˆ·ä¸»åŠ¨å¡«å†™
   - å¤´åƒï¼šä½¿ç”¨ `<button open-type="chooseAvatar">` è®©ç”¨æˆ·é€‰æ‹©å¤´åƒ
   - æ˜µç§°ï¼šä½¿ç”¨ `<input type="nickname">` è®©ç”¨æˆ·è¾“å…¥æ˜µç§°

2. **æ‰‹æœºå·**ï¼šä½¿ç”¨ `<button open-type="getPhoneNumber">` è·å–
   - ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æˆæƒåï¼Œè¿”å›åŠ å¯†æ•°æ®
   - åç«¯éœ€è¦è§£å¯†è·å–çœŸå®æ‰‹æœºå·

---

## å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¸€é”®ç™»å½• + æ‰‹æœºå·æˆæƒï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** å¿«é€Ÿç™»å½•ï¼Œè·å–æ‰‹æœºå·ä½œä¸ºä¸»è¦èº«ä»½æ ‡è¯†

**å®ç°æ­¥éª¤ï¼š**

#### 1. å‰ç«¯å®ç°

**ç™»å½•æŒ‰é’®ï¼ˆä½¿ç”¨ open-typeï¼‰ï¼š**

```vue
<template>
  <!-- å¾®ä¿¡å°ç¨‹åºä½¿ç”¨ open-type è·å–æ‰‹æœºå· -->
  <button
    v-if="platform === 'weixin'"
    class="oneclick-btn"
    open-type="getPhoneNumber"
    @getphonenumber="handleWechatPhoneNumber"
  >
    <image class="platform-icon" src="/static/icons/wechat.png" />
    <text class="btn-text">å¾®ä¿¡ä¸€é”®ç™»å½•</text>
  </button>
</template>
```

**æ‰‹æœºå·æˆæƒå›è°ƒå¤„ç†ï¼š**

```typescript
// å¾®ä¿¡æ‰‹æœºå·æˆæƒå›è°ƒ
const handleWechatPhoneNumber = async (e: any) => {
  console.log('[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] å›è°ƒäº‹ä»¶:', e)

  if (!agreed.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·æ‹’ç»æˆæƒ
  if (e.detail.errMsg && e.detail.errMsg.indexOf('fail') !== -1) {
    console.log('[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] ç”¨æˆ·æ‹’ç»æˆæƒ')
    uni.showToast({
      title: 'æ‚¨æ‹’ç»äº†æˆæƒï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹å¼ç™»å½•',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·åŒæ„æˆæƒ
  if (e.detail.code) {
    loading.value = true

    try {
      // å…ˆè°ƒç”¨ uni.login è·å–ç™»å½•å‡­è¯
      uni.login({
        provider: 'weixin',
        success: async (loginRes) => {
          try {
            console.log('[å¾®ä¿¡ç™»å½•] è·å–codeæˆåŠŸ:', loginRes.code)
            console.log('[å¾®ä¿¡æ‰‹æœºå·] è·å–æ‰‹æœºå·codeæˆåŠŸ:', e.detail.code)

            if (!loginRes.code) {
              throw new Error('è·å–å¾®ä¿¡ç™»å½•codeå¤±è´¥')
            }

            // è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•ï¼ŒåŒæ—¶ä¼ é€’æ‰‹æœºå·æˆæƒcode
            const result = await wechatLogin({
              code: loginRes.code,
              // ä¼ é€’æ‰‹æœºå·åŠ å¯†æ•°æ®ç»™åç«¯è§£å¯†
              encryptedData: e.detail.encryptedData,
              iv: e.detail.iv
            })

            // ä¿å­˜ç™»å½•ä¿¡æ¯
            saveLoginInfo(result.token, result.refreshToken, result.user)

            uni.showToast({
              title: 'ç™»å½•æˆåŠŸ',
              icon: 'success'
            })

            // å»¶è¿Ÿè·³è½¬
            setTimeout(() => {
              handleLoginSuccess()
            }, 1500)
          } catch (error: any) {
            console.error('[å¾®ä¿¡ç™»å½•] ç™»å½•å¤±è´¥:', error)
            uni.showToast({
              title: error.message || 'ç™»å½•å¤±è´¥',
              icon: 'none'
            })
          } finally {
            loading.value = false
          }
        },
        fail: (err) => {
          console.error('[å¾®ä¿¡ç™»å½•] è·å–æˆæƒå¤±è´¥:', err)
          uni.showToast({
            title: err.errMsg || 'è·å–å¾®ä¿¡æˆæƒå¤±è´¥',
            icon: 'none'
          })
          loading.value = false
        }
      })
    } catch (error: any) {
      console.error('[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] å¤„ç†å¤±è´¥:', error)
      uni.showToast({
        title: error.message || 'æˆæƒå¤±è´¥',
        icon: 'none'
      })
      loading.value = false
    }
  } else {
    console.error('[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] æœªè·å–åˆ°code')
    uni.showToast({
      title: 'è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
  }
}
```

#### 2. åç«¯å®ç°ï¼ˆå¾…å¼€å‘ï¼‰

**æ¥å£å®šä¹‰ï¼š**

```typescript
// å¾®ä¿¡ç™»å½•å‚æ•°
interface WechatLoginParams {
  code: string              // å¾®ä¿¡ç™»å½•å‡­è¯
  encryptedData?: string    // æ‰‹æœºå·åŠ å¯†æ•°æ®
  iv?: string               // åŠ å¯†ç®—æ³•åˆå§‹å‘é‡
}

// ç™»å½•å“åº”
interface LoginResponse {
  token: string
  refreshToken: string
  user: {
    id: string
    phone: string           // ä»åŠ å¯†æ•°æ®è§£å¯†å¾—åˆ°
    nickname: string        // é»˜è®¤å€¼æˆ–ç”¨æˆ·åç»­å¡«å†™
    avatar: string          // é»˜è®¤å¤´åƒæˆ–ç”¨æˆ·åç»­ä¸Šä¼ 
    // ... å…¶ä»–å­—æ®µ
  }
}
```

**åç«¯å¤„ç†æµç¨‹ï¼š**

1. æ¥æ”¶å‰ç«¯ä¼ æ¥çš„ `code`ã€`encryptedData`ã€`iv`
2. ä½¿ç”¨ `code` è°ƒç”¨å¾®ä¿¡æ¥å£æ¢å– `session_key` å’Œ `openid`
3. ä½¿ç”¨ `session_key`ã€`encryptedData`ã€`iv` è§£å¯†è·å–æ‰‹æœºå·
4. æ ¹æ® `openid` æˆ–æ‰‹æœºå·æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·
5. ç”Ÿæˆ JWT token è¿”å›ç»™å‰ç«¯

**å¾®ä¿¡æ¥å£è°ƒç”¨ï¼š**

```javascript
// 1. è·å– session_key å’Œ openid
const response = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
  params: {
    appid: 'YOUR_APPID',
    secret: 'YOUR_SECRET',
    js_code: code,
    grant_type: 'authorization_code'
  }
})

const { session_key, openid } = response.data

// 2. è§£å¯†æ‰‹æœºå·
const crypto = require('crypto')

function decryptData(encryptedData, iv, sessionKey) {
  const sessionKeyBuffer = Buffer.from(sessionKey, 'base64')
  const encryptedDataBuffer = Buffer.from(encryptedData, 'base64')
  const ivBuffer = Buffer.from(iv, 'base64')

  const decipher = crypto.createDecipheriv('aes-128-cbc', sessionKeyBuffer, ivBuffer)
  decipher.setAutoPadding(true)

  let decoded = decipher.update(encryptedDataBuffer, null, 'utf8')
  decoded += decipher.final('utf8')

  return JSON.parse(decoded)
}

const phoneData = decryptData(encryptedData, iv, session_key)
console.log('æ‰‹æœºå·:', phoneData.phoneNumber)
```

---

### æ–¹æ¡ˆäºŒï¼šç™»å½•åè¡¥å……å¤´åƒæ˜µç§°ï¼ˆå¯é€‰ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** ç”¨æˆ·ç™»å½•åï¼Œå¼•å¯¼ç”¨æˆ·å®Œå–„ä¸ªäººä¿¡æ¯

#### 1. åˆ›å»ºä¸ªäººä¿¡æ¯å®Œå–„é¡µé¢

**é¡µé¢è·¯å¾„ï¼š** `pages/profile/edit-profile.vue`

**å¤´åƒé€‰æ‹©ç»„ä»¶ï¼š**

```vue
<template>
  <view class="profile-edit-page">
    <view class="avatar-section">
      <text class="label">å¤´åƒ</text>
      <button class="avatar-btn" open-type="chooseAvatar" @chooseavatar="handleChooseAvatar">
        <image class="avatar" :src="userAvatar" mode="aspectFill" />
        <view class="avatar-mask">
          <text>ç‚¹å‡»æ›´æ¢</text>
        </view>
      </button>
    </view>

    <view class="nickname-section">
      <text class="label">æ˜µç§°</text>
      <input
        type="nickname"
        class="nickname-input"
        v-model="userNickname"
        placeholder="è¯·è¾“å…¥æ˜µç§°"
        @blur="handleNicknameBlur"
      />
    </view>

    <button class="save-btn" @click="handleSave">ä¿å­˜</button>
  </view>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { updateUserProfile } from '@/api/auth'

const userAvatar = ref('/static/default-avatar.png')
const userNickname = ref('')

// é€‰æ‹©å¤´åƒå›è°ƒ
const handleChooseAvatar = (e: any) => {
  console.log('[é€‰æ‹©å¤´åƒ] å›è°ƒ:', e)

  if (e.detail.avatarUrl) {
    // ä¸´æ—¶æ˜¾ç¤ºå¤´åƒ
    userAvatar.value = e.detail.avatarUrl

    // ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨
    uni.uploadFile({
      url: 'https://your-api.com/upload/avatar',
      filePath: e.detail.avatarUrl,
      name: 'file',
      success: (uploadRes) => {
        const data = JSON.parse(uploadRes.data)
        userAvatar.value = data.url
        console.log('[ä¸Šä¼ å¤´åƒ] æˆåŠŸ:', data.url)
      },
      fail: (err) => {
        console.error('[ä¸Šä¼ å¤´åƒ] å¤±è´¥:', err)
        uni.showToast({
          title: 'ä¸Šä¼ å¤´åƒå¤±è´¥',
          icon: 'none'
        })
      }
    })
  }
}

// æ˜µç§°è¾“å…¥å¤±ç„¦
const handleNicknameBlur = (e: any) => {
  console.log('[æ˜µç§°è¾“å…¥] å€¼:', e.detail.value)
  userNickname.value = e.detail.value
}

// ä¿å­˜ä¸ªäººä¿¡æ¯
const handleSave = async () => {
  if (!userNickname.value) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æ˜µç§°',
      icon: 'none'
    })
    return
  }

  try {
    await updateUserProfile({
      nickname: userNickname.value,
      avatar: userAvatar.value
    })

    uni.showToast({
      title: 'ä¿å­˜æˆåŠŸ',
      icon: 'success'
    })

    setTimeout(() => {
      uni.navigateBack()
    }, 1500)
  } catch (error: any) {
    uni.showToast({
      title: error.message || 'ä¿å­˜å¤±è´¥',
      icon: 'none'
    })
  }
}
</script>
```

#### 2. ç™»å½•åå¼•å¯¼æµç¨‹

```typescript
// ç™»å½•æˆåŠŸåæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´
const result = await wechatLogin({ code: loginRes.code })

// ä¿å­˜ç™»å½•ä¿¡æ¯
saveLoginInfo(result.token, result.refreshToken, result.user)

// æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œå–„ä¿¡æ¯
if (!result.user.nickname || !result.user.avatar) {
  // è·³è½¬åˆ°ä¸ªäººä¿¡æ¯å®Œå–„é¡µé¢
  uni.navigateTo({
    url: '/pages/profile/edit-profile?from=login'
  })
} else {
  // ç›´æ¥è·³è½¬åˆ°é¦–é¡µ
  handleLoginSuccess()
}
```

---

## å®Œæ•´ç™»å½•æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
         â†“
è§¦å‘ open-type="getPhoneNumber"
         â†“
ç”¨æˆ·æˆæƒæ‰‹æœºå·
         â†“
è·å– encryptedData å’Œ iv
         â†“
è°ƒç”¨ uni.login è·å– code
         â†“
å‘é€ code + encryptedData + iv åˆ°åç«¯
         â†“
åç«¯è§£å¯†è·å–æ‰‹æœºå·
         â†“
åç«¯åˆ›å»º/æŸ¥è¯¢ç”¨æˆ·
         â†“
è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
         â†“
å‰ç«¯ä¿å­˜ç™»å½•çŠ¶æ€
         â†“
æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´
         â†“
â”œâ”€ å®Œæ•´ â†’ è·³è½¬é¦–é¡µ
â””â”€ ä¸å®Œæ•´ â†’ å¼•å¯¼å®Œå–„å¤´åƒæ˜µç§°
```

---

## ä»£ç å˜æ›´æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. **[miniprogram/pages/auth/login.vue](../pages/auth/login.vue)**
   - ä¿®æ”¹å¾®ä¿¡ç™»å½•æŒ‰é’®ä¸º `open-type="getPhoneNumber"`
   - æ–°å¢ `handleWechatPhoneNumber` å›è°ƒå‡½æ•°
   - å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### å…³é”®ä»£ç å˜æ›´

#### 1. ç™»å½•æŒ‰é’®ä¿®æ”¹

**ä¿®æ”¹å‰ï¼š**
```vue
<button class="oneclick-btn" @click="handleOneClickLogin">
  <image class="platform-icon" :src="platformIcon" />
  <text class="btn-text">{{ oneClickLoginText }}</text>
</button>
```

**ä¿®æ”¹åï¼š**
```vue
<!-- å¾®ä¿¡å°ç¨‹åºä½¿ç”¨ open-type è·å–æ‰‹æœºå· -->
<button
  v-if="platform === 'weixin'"
  class="oneclick-btn"
  open-type="getPhoneNumber"
  @getphonenumber="handleWechatPhoneNumber"
>
  <image class="platform-icon" :src="platformIcon" />
  <text class="btn-text">{{ oneClickLoginText }}</text>
</button>

<!-- æ”¯ä»˜å®å’ŒæŠ–éŸ³ä½¿ç”¨æ™®é€šç‚¹å‡» -->
<button
  v-else
  class="oneclick-btn"
  @click="handleOneClickLogin"
>
  <image class="platform-icon" :src="platformIcon" />
  <text class="btn-text">{{ oneClickLoginText }}</text>
</button>
```

#### 2. æ–°å¢æ‰‹æœºå·æˆæƒå›è°ƒ

```typescript
// å¾®ä¿¡æ‰‹æœºå·æˆæƒå›è°ƒ
const handleWechatPhoneNumber = async (e: any) => {
  // æ£€æŸ¥ç”¨æˆ·åè®®
  if (!agreed.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·æ‹’ç»æˆæƒ
  if (e.detail.errMsg && e.detail.errMsg.indexOf('fail') !== -1) {
    uni.showToast({
      title: 'æ‚¨æ‹’ç»äº†æˆæƒï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹å¼ç™»å½•',
      icon: 'none'
    })
    return
  }

  // ç”¨æˆ·åŒæ„æˆæƒï¼Œè·å–åŠ å¯†æ•°æ®
  if (e.detail.code) {
    // è°ƒç”¨ uni.login è·å–ç™»å½•å‡­è¯
    uni.login({
      provider: 'weixin',
      success: async (loginRes) => {
        // è°ƒç”¨åç«¯APIï¼Œä¼ é€’åŠ å¯†æ•°æ®
        const result = await wechatLogin({
          code: loginRes.code,
          encryptedData: e.detail.encryptedData,
          iv: e.detail.iv
        })

        // ä¿å­˜ç™»å½•ä¿¡æ¯
        saveLoginInfo(result.token, result.refreshToken, result.user)

        // ç™»å½•æˆåŠŸ
        handleLoginSuccess()
      }
    })
  }
}
```

---

## API æ¥å£è¯´æ˜

### å‰ç«¯ API æ¥å£

**æ–‡ä»¶ï¼š** `miniprogram/api/auth.ts`

```typescript
// å¾®ä¿¡ç™»å½•å‚æ•°æ¥å£
export interface WechatLoginParams {
  code: string              // å¾®ä¿¡ç™»å½•å‡­è¯ï¼ˆå¿…å¡«ï¼‰
  encryptedData?: string    // æ‰‹æœºå·åŠ å¯†æ•°æ®ï¼ˆå¯é€‰ï¼‰
  iv?: string               // åŠ å¯†ç®—æ³•åˆå§‹å‘é‡ï¼ˆå¯é€‰ï¼‰
}

// å¾®ä¿¡ç™»å½•å‡½æ•°
export function wechatLogin(params: WechatLoginParams): Promise<LoginResponse> {
  return new Promise((resolve) => {
    setTimeout(() => {
      console.log('[Mock] å¾®ä¿¡æˆæƒç™»å½•:', params)
      resolve({
        token: mockToken,
        refreshToken: mockRefreshToken,
        user: {
          ...mockUser,
          nickname: 'å¾®ä¿¡ç”¨æˆ·',
          avatar: '/static/default-avatar.png',
          // å¦‚æœæœ‰ encryptedDataï¼Œåç«¯ä¼šè§£å¯†è·å–çœŸå®æ‰‹æœºå·
          phone: params.encryptedData ? '13800138000' : ''
        }
      })
    }, 1000)
  })
}
```

### åç«¯ API æ¥å£ï¼ˆå¾…å¼€å‘ï¼‰

**æ¥å£è·¯å¾„ï¼š** `POST /api/auth/wechat/login`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "code": "081xYz000Ey8Ks1234567890",
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZM...",
  "iv": "r7BXXKkLb8qrSNn05n0qiA=="
}
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "user_001",
    "phone": "13800138000",
    "nickname": "å¾®ä¿¡ç”¨æˆ·",
    "avatar": "https://cdn.example.com/avatar/default.png",
    "openid": "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o",
    "userType": "NORMAL",
    "status": "ACTIVE"
  }
}
```

---

## æµ‹è¯•æŒ‡å—

### 1. å¾®ä¿¡å¼€å‘è€…å·¥å…·æµ‹è¯•

**æ­¥éª¤ï¼š**

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. å¯¼å…¥å°ç¨‹åºé¡¹ç›®
3. ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
4. åœ¨å¼¹å‡ºçš„æˆæƒçª—å£ä¸­ç‚¹å‡»"å…è®¸"
5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è¾“å‡º

**é¢„æœŸç»“æœï¼š**

```
[å¾®ä¿¡æ‰‹æœºå·æˆæƒ] å›è°ƒäº‹ä»¶: { detail: { code: "xxx", encryptedData: "xxx", iv: "xxx" } }
[å¾®ä¿¡ç™»å½•] è·å–codeæˆåŠŸ: 081xYz000Ey8Ks1234567890
[å¾®ä¿¡æ‰‹æœºå·] è·å–æ‰‹æœºå·codeæˆåŠŸ: xxx
[Mock] å¾®ä¿¡æˆæƒç™»å½•: { code: "xxx", encryptedData: "xxx", iv: "xxx" }
```

### 2. çœŸæœºæµ‹è¯•

**æ³¨æ„äº‹é¡¹ï¼š**

1. éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®å°ç¨‹åºä¿¡æ¯
2. éœ€è¦é…ç½®æœåŠ¡å™¨åŸŸåç™½åå•
3. éœ€è¦åç«¯æ¥å£æ”¯æŒæ‰‹æœºå·è§£å¯†

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ä½¿ç”¨å¾®ä¿¡æ‰«ç é¢„è§ˆå°ç¨‹åº
2. ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
3. æˆæƒæ‰‹æœºå·
4. éªŒè¯ç™»å½•æ˜¯å¦æˆåŠŸ
5. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®

---

## å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·æ‹’ç»æˆæƒæ‰‹æœºå·æ€ä¹ˆåŠï¼Ÿ

**A:** æä¾›å…¶ä»–ç™»å½•æ–¹å¼ä½œä¸ºå¤‡é€‰ï¼š
- æ‰‹æœºå· + éªŒè¯ç ç™»å½•
- æ‰‹æœºå· + å¯†ç ç™»å½•
- ç”¨æˆ·å + å¯†ç ç™»å½•

### Q2: å¦‚ä½•è·å–ç”¨æˆ·å¤´åƒå’Œæ˜µç§°ï¼Ÿ

**A:** å¾®ä¿¡å·²åºŸå¼ƒç›´æ¥è·å–æ¥å£ï¼Œéœ€è¦ï¼š
- ä½¿ç”¨ `<button open-type="chooseAvatar">` è®©ç”¨æˆ·é€‰æ‹©å¤´åƒ
- ä½¿ç”¨ `<input type="nickname">` è®©ç”¨æˆ·è¾“å…¥æ˜µç§°
- åœ¨ç”¨æˆ·ç™»å½•åå¼•å¯¼å®Œå–„ä¸ªäººä¿¡æ¯

### Q3: åç«¯å¦‚ä½•è§£å¯†æ‰‹æœºå·ï¼Ÿ

**A:** ä½¿ç”¨å¾®ä¿¡æä¾›çš„è§£å¯†ç®—æ³•ï¼š
1. ä½¿ç”¨ `code` æ¢å– `session_key`
2. ä½¿ç”¨ `session_key`ã€`encryptedData`ã€`iv` è§£å¯†
3. è§£å¯†ç®—æ³•ï¼šAES-128-CBC

### Q4: æ”¯ä»˜å®å’ŒæŠ–éŸ³å¦‚ä½•è·å–æ‰‹æœºå·ï¼Ÿ

**A:**
- **æ”¯ä»˜å®**ï¼šä½¿ç”¨ `<button open-type="getAuthorize" scope="phoneNumber">`
- **æŠ–éŸ³**ï¼šä½¿ç”¨ `<button open-type="getPhoneNumber">`

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œå–„å¼•å¯¼

```typescript
// ç™»å½•æˆåŠŸåæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
if (!result.user.nickname || !result.user.avatar) {
  uni.showModal({
    title: 'å®Œå–„ä¸ªäººä¿¡æ¯',
    content: 'ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œå»ºè®®æ‚¨å®Œå–„å¤´åƒå’Œæ˜µç§°',
    confirmText: 'å»å®Œå–„',
    cancelText: 'ç¨åå†è¯´',
    success: (res) => {
      if (res.confirm) {
        uni.navigateTo({
          url: '/pages/profile/edit-profile'
        })
      } else {
        handleLoginSuccess()
      }
    }
  })
}
```

### 2. æ·»åŠ ç™»å½•çŠ¶æ€æŒä¹…åŒ–

```typescript
// ä¿å­˜ç™»å½•æ—¶é—´
uni.setStorageSync('lastLoginTime', Date.now())

// æ£€æŸ¥ç™»å½•æ˜¯å¦è¿‡æœŸï¼ˆ7å¤©ï¼‰
const lastLoginTime = uni.getStorageSync('lastLoginTime')
const now = Date.now()
const sevenDays = 7 * 24 * 60 * 60 * 1000

if (now - lastLoginTime > sevenDays) {
  // ç™»å½•å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
  uni.removeStorageSync('token')
  uni.removeStorageSync('userInfo')
}
```

### 3. æ·»åŠ ç™»å½•åŸ‹ç‚¹ç»Ÿè®¡

```typescript
// ç™»å½•æˆåŠŸåŸ‹ç‚¹
trackEvent('login_success', {
  platform: 'weixin',
  method: 'phone_number',
  timestamp: Date.now()
})

// ç™»å½•å¤±è´¥åŸ‹ç‚¹
trackEvent('login_fail', {
  platform: 'weixin',
  error: error.message,
  timestamp: Date.now()
})
```

---

## å‚è€ƒæ–‡æ¡£

### å®˜æ–¹æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºç™»å½•](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [å¾®ä¿¡å°ç¨‹åºè·å–æ‰‹æœºå·](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [å¾®ä¿¡å°ç¨‹åºå¤´åƒæ˜µç§°å¡«å†™](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)
- [uni-app uni.login API](https://uniapp.dcloud.net.cn/api/plugins/login.html)

### é¡¹ç›®æ–‡æ¡£

- [å°ç¨‹åºç«¯ API æ–‡æ¡£](./å°ç¨‹åºç«¯API.md)
- [ä¸€é”®ç™»å½•ä¿®å¤æŠ¥å‘Š](./ä¸€é”®ç™»å½•ä¿®å¤æŠ¥å‘Š.md)

---

## ä¿®å¤å®Œæˆç¡®è®¤

- âœ… å¾®ä¿¡å°ç¨‹åºä¸€é”®ç™»å½•æŒ‰é’®å·²ä¿®æ”¹ä¸º `open-type="getPhoneNumber"`
- âœ… æ‰‹æœºå·æˆæƒå›è°ƒå¤„ç†å·²å®ç°
- âœ… API æ¥å£å·²æ”¯æŒæ‰‹æœºå·åŠ å¯†æ•°æ®ä¼ é€’
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡ºå·²å®Œå–„
- âœ… æ”¯ä»˜å®å’ŒæŠ–éŸ³ç™»å½•ä¿æŒåŸæœ‰å®ç°
- â³ åç«¯æ‰‹æœºå·è§£å¯†åŠŸèƒ½å¾…å¼€å‘
- â³ ç”¨æˆ·ä¿¡æ¯å®Œå–„é¡µé¢å¾…å¼€å‘ï¼ˆå¯é€‰ï¼‰

**ä¿®å¤çŠ¶æ€ï¼š** ğŸŸ¢ å‰ç«¯å·²å®Œæˆï¼Œç­‰å¾…åç«¯å¯¹æ¥

**å»ºè®®ï¼š**
1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•æ‰‹æœºå·æˆæƒæµç¨‹
2. åç«¯å¼€å‘æ‰‹æœºå·è§£å¯†æ¥å£
3. è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
4. æ ¹æ®éœ€è¦æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œå–„å¼•å¯¼
