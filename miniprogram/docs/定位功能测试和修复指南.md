# å®šä½åŠŸèƒ½æµ‹è¯•å’Œä¿®å¤æŒ‡å—

## ğŸš¨ å½“å‰é—®é¢˜åˆ†æ

æ ¹æ®æœ€æ–°çš„é”™è¯¯æ—¥å¿—ï¼š

```
[å®šä½] è·å–ä½ç½®å¤±è´¥: {errMsg: "getLocation:fail the api need to be declared in the requiredPrivateInfos field in app.json/ext.json"}
```

**é—®é¢˜åŸå› **: è™½ç„¶æˆ‘ä»¬å·²ç»åœ¨ `manifest.json` ä¸­æ·»åŠ äº† `requiredPrivateInfos` é…ç½®ï¼Œä½† **uni-app é¡¹ç›®éœ€è¦é‡æ–°ç¼–è¯‘æ‰èƒ½è®©å¾®ä¿¡å¼€å‘è€…å·¥å…·è¯†åˆ«è¿™ä¸ªé…ç½®**ã€‚

---

## âœ… å®Œæ•´ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: éªŒè¯ manifest.json é…ç½®

ç¡®è®¤ `miniprogram/manifest.json` ä¸­å·²åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```json
{
	"mp-weixin": {
		"appid": "wx545d8668053b84a8",
		"permission": {
			"scope.userLocation": {
				"desc": "ä»…ç”¨äºä¸ºæ‚¨æä¾›é™„è¿‘é—¨åº—æœåŠ¡"
			}
		},
		"requiredPrivateInfos": [
			"getLocation"
		]
	}
}
```

âœ… **å·²ç¡®è®¤**: é…ç½®æ­£ç¡®ï¼ˆç¬¬ 65-67 è¡Œï¼‰

### æ­¥éª¤ 2: é‡æ–°ç¼–è¯‘å°ç¨‹åºï¼ˆå…³é”®æ­¥éª¤ï¼‰

**åœ¨ HBuilderX ä¸­**:

1. **åœæ­¢å½“å‰è¿è¡Œ**
   - ç‚¹å‡» HBuilderX é¡¶éƒ¨çš„"åœæ­¢"æŒ‰é’®
   - æˆ–æŒ‰å¿«æ·é”® `Ctrl + F2`

2. **æ¸…ç†ç¼“å­˜**
   - èœå•æ  â†’ è¿è¡Œ â†’ æ¸…ç†ç¼“å­˜
   - æˆ–è€…åˆ é™¤ `miniprogram/unpackage` ç›®å½•

3. **é‡æ–°è¿è¡Œåˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·**
   - èœå•æ  â†’ è¿è¡Œ â†’ è¿è¡Œåˆ°å°ç¨‹åºæ¨¡æ‹Ÿå™¨ â†’ å¾®ä¿¡å¼€å‘è€…å·¥å…·
   - æˆ–æŒ‰å¿«æ·é”® `Ctrl + R`

**åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­**:

1. **æ¸…é™¤ç¼“å­˜æ•°æ®**
   - ç‚¹å‡»é¡¶éƒ¨èœå• â†’ å·¥å…· â†’ æ¸…é™¤ç¼“å­˜
   - å‹¾é€‰"æ¸…é™¤æˆæƒæ•°æ®"
   - ç‚¹å‡»"æ¸…é™¤"

2. **é‡æ–°ç¼–è¯‘**
   - ç‚¹å‡»é¡¶éƒ¨çš„"ç¼–è¯‘"æŒ‰é’®
   - æˆ–æŒ‰å¿«æ·é”® `Ctrl + B`

3. **æŸ¥çœ‹ç¼–è¯‘åçš„ app.json**
   - åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ä¸­æ‰¾åˆ° `app.json`
   - ç¡®è®¤å…¶ä¸­åŒ…å« `requiredPrivateInfos` å­—æ®µï¼š
   ```json
   {
     "requiredPrivateInfos": ["getLocation"]
   }
   ```

### æ­¥éª¤ 3: æµ‹è¯•å®šä½åŠŸèƒ½

**æµ‹è¯•åœºæ™¯ 1: é¦–æ¬¡æˆæƒ**

1. æ¸…é™¤å°ç¨‹åºç¼“å­˜ï¼ˆæ­¥éª¤ 2 å·²å®Œæˆï¼‰
2. é‡æ–°æ‰“å¼€å°ç¨‹åº
3. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—

**é¢„æœŸæ—¥å¿—**:
```
[é¦–é¡µ] å¼€å§‹è·å–ç”¨æˆ·ä½ç½®
[å®šä½] æƒé™çŠ¶æ€: not determined
[å®šä½] è·å–ä½ç½®æˆåŠŸ: {latitude: 39.9042, longitude: 116.4074, ...}
[é¦–é¡µ] è·å–ä½ç½®æˆåŠŸ: {latitude: 39.9042, longitude: 116.4074, ...}
[é¦–é¡µ] å½“å‰åŸå¸‚: åŒ—äº¬
```

**é¢„æœŸç•Œé¢**:
- å¼¹å‡ºæˆæƒçª—å£ï¼ˆä»…1æ¬¡ï¼‰
- ç”¨æˆ·ç‚¹å‡»"å…è®¸"åæ˜¾ç¤º"å®šä½æˆåŠŸï¼šåŒ—äº¬"

**æµ‹è¯•åœºæ™¯ 2: ç”¨æˆ·æ‹’ç»æˆæƒ**

1. é¦–æ¬¡æ‰“å¼€å°ç¨‹åº
2. ç‚¹å‡»"æ‹’ç»"æˆæƒ
3. è§‚å¯Ÿæç¤ºä¿¡æ¯

**é¢„æœŸç»“æœ**:
- æ˜¾ç¤º"å®šä½æƒé™è¢«æ‹’ç»ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨"
- ä½¿ç”¨é»˜è®¤åŸå¸‚"åŒ—äº¬"

**æµ‹è¯•åœºæ™¯ 3: å·²æ‹’ç»åå¼•å¯¼**

1. å·²æ‹’ç»æˆæƒçš„çŠ¶æ€ä¸‹é‡æ–°æ‰“å¼€å°ç¨‹åº
2. è§‚å¯Ÿæ˜¯å¦å¼¹å‡ºå¼•å¯¼å¼¹çª—

**é¢„æœŸç»“æœ**:
- å¼¹å‡ºå¼•å¯¼å¼¹çª—ï¼š"éœ€è¦å®šä½æƒé™"
- ç‚¹å‡»"å»è®¾ç½®"è·³è½¬åˆ°è®¾ç½®é¡µé¢

---

## ğŸ” é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶æç¤º "need to be declared in the requiredPrivateInfos"

**å¯èƒ½åŸå› **:
1. æ²¡æœ‰é‡æ–°ç¼–è¯‘å°ç¨‹åº
2. å¾®ä¿¡å¼€å‘è€…å·¥å…·ç¼“å­˜æœªæ¸…é™¤
3. HBuilderX ç¼“å­˜æœªæ¸…é™¤

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å®Œå…¨å…³é—­ HBuilderX å’Œå¾®ä¿¡å¼€å‘è€…å·¥å…·
# 2. åˆ é™¤ç¼–è¯‘ç¼“å­˜
åˆ é™¤ç›®å½•: miniprogram/unpackage

# 3. é‡æ–°å¯åŠ¨ HBuilderX
# 4. é‡æ–°è¿è¡Œåˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·
# 5. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ¸…é™¤ç¼“å­˜
# 6. é‡æ–°ç¼–è¯‘
```

### é—®é¢˜ 2: æƒé™çŠ¶æ€æ˜¾ç¤ºä¸¤æ¬¡

**æ—¥å¿—ç¤ºä¾‹**:
```
[å®šä½] æƒé™çŠ¶æ€: not determined
[å®šä½] æƒé™çŠ¶æ€: not determined
```

**å¯èƒ½åŸå› **:
1. é¡µé¢è¢«åŠ è½½äº†ä¸¤æ¬¡ï¼ˆçƒ­é‡è½½å¯¼è‡´ï¼‰
2. `onMounted` è¢«è§¦å‘äº†ä¸¤æ¬¡

**è§£å†³æ–¹æ¡ˆ**:
- è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸å½±å“åŠŸèƒ½
- å¦‚æœæƒ³é¿å…ï¼Œå¯ä»¥æ·»åŠ é˜²æŠ–é€»è¾‘ï¼š

```typescript
// æ·»åŠ é˜²æŠ–æ ‡å¿—
let isLocationInitialized = false;

const initLocation = async () => {
	if (isLocationInitialized) {
		console.log('[é¦–é¡µ] å®šä½å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
		return;
	}
	isLocationInitialized = true;

	try {
		// ... åŸæœ‰ä»£ç 
	} catch (error) {
		// ... åŸæœ‰ä»£ç 
		isLocationInitialized = false; // å¤±è´¥åé‡ç½®ï¼Œå…è®¸é‡è¯•
	}
};
```

### é—®é¢˜ 3: å®šä½è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**:
```
[å®šä½] è·å–ä½ç½®å¤±è´¥: {type: "TIMEOUT", message: "å®šä½è¶…æ—¶"}
```

**å¯èƒ½åŸå› **:
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. æ¨¡æ‹Ÿå™¨å®šä½æœåŠ¡æœªå¼€å¯
3. è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å¢åŠ è¶…æ—¶æ—¶é—´
const location = await getUserLocation({
	type: 'gcj02',
	showLoading: true,
	timeout: 15000 // ä» 10 ç§’å¢åŠ åˆ° 15 ç§’
});
```

### é—®é¢˜ 4: å®šä½æœåŠ¡ä¸å¯ç”¨

**é”™è¯¯ä¿¡æ¯**:
```
[å®šä½] è·å–ä½ç½®å¤±è´¥: {type: "LOCATION_UNAVAILABLE", message: "å®šä½æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æ‰‹æœºå®šä½è®¾ç½®"}
```

**å¯èƒ½åŸå› **:
1. å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„æ¨¡æ‹Ÿå™¨å®šä½æœªå¼€å¯
2. ç³»ç»Ÿå®šä½æœåŠ¡æœªå¼€å¯

**è§£å†³æ–¹æ¡ˆ**:

**åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­**:
1. ç‚¹å‡»å³ä¾§"æ¨¡æ‹Ÿå™¨"æ ‡ç­¾
2. æ‰¾åˆ°"ä½ç½®"è®¾ç½®
3. é€‰æ‹©ä¸€ä¸ªæ¨¡æ‹Ÿä½ç½®ï¼ˆå¦‚"åŒ—äº¬"ï¼‰
4. æˆ–è€…è¾“å…¥è‡ªå®šä¹‰ç»çº¬åº¦

**åœ¨çœŸæœºè°ƒè¯•æ—¶**:
1. ç¡®ä¿æ‰‹æœºå®šä½æœåŠ¡å·²å¼€å¯
2. ç¡®ä¿å¾®ä¿¡æœ‰å®šä½æƒé™
3. ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸

---

## ğŸ“ éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ­¥éª¤åï¼Œå®šä½åŠŸèƒ½åº”è¯¥æ­£å¸¸å·¥ä½œï¼š

- [ ] 1. ç¡®è®¤ `manifest.json` ä¸­æœ‰ `requiredPrivateInfos: ["getLocation"]`
- [ ] 2. åœ¨ HBuilderX ä¸­æ¸…ç†ç¼“å­˜
- [ ] 3. åœ¨ HBuilderX ä¸­é‡æ–°è¿è¡Œåˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·
- [ ] 4. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ¸…é™¤ç¼“å­˜ï¼ˆåŒ…æ‹¬æˆæƒæ•°æ®ï¼‰
- [ ] 5. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­é‡æ–°ç¼–è¯‘
- [ ] 6. éªŒè¯ç¼–è¯‘åçš„ `app.json` åŒ…å« `requiredPrivateInfos`
- [ ] 7. è®¾ç½®æ¨¡æ‹Ÿå™¨ä½ç½®ï¼ˆå¦‚"åŒ—äº¬"ï¼‰
- [ ] 8. æµ‹è¯•é¦–æ¬¡æˆæƒï¼ˆåº”è¯¥åªå¼¹å‡º1æ¬¡æˆæƒçª—å£ï¼‰
- [ ] 9. æµ‹è¯•æ‹’ç»æˆæƒï¼ˆåº”è¯¥æ˜¾ç¤ºå‹å¥½æç¤ºï¼‰
- [ ] 10. æµ‹è¯•å·²æ‹’ç»åå¼•å¯¼ï¼ˆåº”è¯¥å¼¹å‡ºå¼•å¯¼å¼¹çª—ï¼‰

---

## ğŸ¯ é¢„æœŸæœ€ç»ˆæ•ˆæœ

### æˆåŠŸæ—¥å¿—ç¤ºä¾‹

```
15:45:00.123 [é¦–é¡µ] å¼€å§‹è·å–ç”¨æˆ·ä½ç½®
15:45:00.234 [å®šä½] æƒé™çŠ¶æ€: not determined
15:45:02.456 [å®šä½] è·å–ä½ç½®æˆåŠŸ: {
  latitude: 39.9042,
  longitude: 116.4074,
  speed: 0,
  accuracy: 65,
  altitude: 0,
  verticalAccuracy: 65,
  horizontalAccuracy: 65
}
15:45:02.457 [é¦–é¡µ] è·å–ä½ç½®æˆåŠŸ: {latitude: 39.9042, longitude: 116.4074, ...}
15:45:02.458 [é¦–é¡µ] å½“å‰åŸå¸‚: åŒ—äº¬
```

### æˆåŠŸç•Œé¢æ•ˆæœ

1. **åŠ è½½æç¤º**: æ˜¾ç¤º"å®šä½ä¸­..."ï¼ˆå¸¦é®ç½©ï¼‰
2. **æˆæƒå¼¹çª—**: ä»…å¼¹å‡º1æ¬¡ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰
3. **æˆåŠŸæç¤º**: æ˜¾ç¤º"å®šä½æˆåŠŸï¼šåŒ—äº¬"ï¼ˆç»¿è‰²å¯¹å‹¾å›¾æ ‡ï¼‰
4. **æ§åˆ¶å°**: æ˜¾ç¤ºå®Œæ•´çš„å®šä½ä¿¡æ¯

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ç¼–è¯‘åçš„é…ç½®

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
```
å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ â†’ app.json â†’ æœç´¢ "requiredPrivateInfos"
```

åº”è¯¥çœ‹åˆ°ï¼š
```json
{
  "requiredPrivateInfos": ["getLocation"],
  "permission": {
    "scope.userLocation": {
      "desc": "ä»…ç”¨äºä¸ºæ‚¨æä¾›é™„è¿‘é—¨åº—æœåŠ¡"
    }
  }
}
```

### 2. æŸ¥çœ‹æƒé™çŠ¶æ€

åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
wx.getSetting({
  success(res) {
    console.log('æƒé™çŠ¶æ€:', res.authSetting);
  }
});
```

åº”è¯¥çœ‹åˆ°ï¼š
```javascript
{
  "scope.userLocation": true  // å·²æˆæƒ
  // æˆ– falseï¼ˆå·²æ‹’ç»ï¼‰
  // æˆ– undefinedï¼ˆæœªè¯¢é—®ï¼‰
}
```

### 3. æ‰‹åŠ¨æµ‹è¯•å®šä½

åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
wx.getLocation({
  type: 'gcj02',
  success(res) {
    console.log('å®šä½æˆåŠŸ:', res);
  },
  fail(err) {
    console.error('å®šä½å¤±è´¥:', err);
  }
});
```

### 4. æŸ¥çœ‹å°ç¨‹åºåŸºç¡€åº“ç‰ˆæœ¬

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·å³ä¸Šè§’æŸ¥çœ‹åŸºç¡€åº“ç‰ˆæœ¬ï¼Œç¡®ä¿ >= 2.10.0

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [å¾®ä¿¡å°ç¨‹åº - requiredPrivateInfos é…ç½®](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#requiredPrivateInfos)
2. [å¾®ä¿¡å°ç¨‹åº - wx.getLocation](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html)
3. [uni-app - manifest.json é…ç½®](https://uniapp.dcloud.net.cn/collocation/manifest.html)
4. [å¾®ä¿¡å°ç¨‹åº - éšç§æ¥å£æ£€æµ‹](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/)

---

## ğŸ†˜ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ“ä½œåä»ç„¶æ— æ³•è§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—**ï¼ˆä»é¡µé¢åŠ è½½åˆ°å®šä½å¤±è´¥çš„å…¨éƒ¨æ—¥å¿—ï¼‰
2. **å¾®ä¿¡å¼€å‘è€…å·¥å…·ç‰ˆæœ¬**ï¼ˆé¡¶éƒ¨èœå• â†’ å¸®åŠ© â†’ å…³äºï¼‰
3. **å°ç¨‹åºåŸºç¡€åº“ç‰ˆæœ¬**ï¼ˆå³ä¸Šè§’æ˜¾ç¤ºï¼‰
4. **ç¼–è¯‘åçš„ app.json å†…å®¹**ï¼ˆæ˜¯å¦åŒ…å« requiredPrivateInfosï¼‰
5. **HBuilderX ç‰ˆæœ¬**ï¼ˆèœå• â†’ å¸®åŠ© â†’ å…³äºï¼‰

---

## âœ… å¿«é€Ÿä¿®å¤å‘½ä»¤

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ HBuilderXï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ“ä½œï¼š

```
1. Ctrl + F2          # åœæ­¢è¿è¡Œ
2. èœå• â†’ è¿è¡Œ â†’ æ¸…ç†ç¼“å­˜
3. åˆ é™¤ miniprogram/unpackage ç›®å½•
4. Ctrl + R           # é‡æ–°è¿è¡Œåˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·
5. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
   - å·¥å…· â†’ æ¸…é™¤ç¼“å­˜ â†’ å‹¾é€‰"æ¸…é™¤æˆæƒæ•°æ®" â†’ æ¸…é™¤
   - Ctrl + B         # é‡æ–°ç¼–è¯‘
6. æµ‹è¯•å®šä½åŠŸèƒ½
```

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-12-12
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… å¾…æµ‹è¯•éªŒè¯
