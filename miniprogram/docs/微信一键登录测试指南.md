# 微信一键登录测试指南

## 测试日期
2025-12-12

## 测试环境

### 开发工具
- 微信开发者工具
- uni-app 项目
- Mock 数据模式

### 测试账号
- 使用微信开发者工具的测试账号
- 无需真实后端接口

---

## 完整测试流程

### 测试场景1：首次登录 - 完善信息

#### 步骤：

1. **打开登录页面**
   ```
   路径：pages/auth/login
   ```

2. **点击"微信一键登录"按钮**
   - 触发手机号授权弹窗
   - 点击"允许"授权

3. **查看控制台日志**
   ```
   预期日志：
   [登录页面] 当前平台: weixin 支持一键登录: true
   [微信手机号授权] 回调事件: {...}
   [微信登录] 获取code成功: xxx
   [微信手机号] 获取手机号code成功: xxx
   [Mock] 微信授权登录: {code: "xxx", encryptedData: "xxx", iv: "xxx"}
   [Auth] 登录信息已保存
   [微信登录] 需要完善用户信息  ← 关键日志
   ```

4. **验证跳转**
   - 显示"登录成功"提示（1.5秒）
   - 自动跳转到完善信息页面
   - 页面路径：`/pages/profile/complete-info?from=login`

5. **完善信息页面**
   - 显示"完善个人信息"标题
   - 显示默认头像（叨叨房车logo）
   - 昵称输入框为空
   - 显示两个按钮：
     - "保存"按钮（灰色禁用状态）
     - "暂时跳过，使用默认信息"按钮（可点击）

6. **选项A：完善信息**
   - 点击头像区域
   - 选择一张图片
   - 输入昵称（2-20个字符）
   - 可选：选择性别
   - 点击"保存"按钮
   - 显示"保存成功"提示
   - 跳转到首页

7. **选项B：跳过**
   - 点击"暂时跳过，使用默认信息"按钮
   - 查看控制台日志：
     ```
     [跳过完善信息] 生成默认信息: {defaultNickname: "叨叨车友123", defaultAvatar: "/static/logo.png"}
     [Mock] 更新用户资料: {nickname: "叨叨车友123", avatar: "/static/logo.png", gender: 0}
     [跳过完善信息] 保存成功，跳转首页
     ```
   - 显示"已使用默认信息"提示
   - 跳转到首页

---

### 测试场景2：已有信息用户登录

#### 模拟方法：

修改 Mock 数据，模拟已有信息的用户：

```typescript
// 在 api/auth.ts 中临时修改
const isFirstLogin = false  // 改为 false

// 或者注释掉 encryptedData 的判断
nickname: '微信用户',
avatar: '/static/default-avatar.png',
```

#### 预期结果：

1. 点击"微信一键登录"
2. 授权手机号
3. 显示"登录成功"提示
4. **直接跳转到首页**（不跳转到完善信息页面）

---

## 关键测试点

### 1. Mock 数据逻辑

**文件：** `miniprogram/api/auth.ts:195-218`

```typescript
export function wechatLogin(params: WechatLoginParams): Promise<LoginResponse> {
  return new Promise((resolve) => {
    setTimeout(() => {
      console.log('[Mock] 微信授权登录:', params)

      // 模拟首次登录：返回空的昵称和头像，触发完善信息流程
      // 如果有 encryptedData，说明获取了手机号，但首次登录用户信息为空
      const isFirstLogin = !!params.encryptedData

      resolve({
        token: mockToken,
        refreshToken: mockRefreshToken,
        user: {
          ...mockUser,
          // 首次登录返回空昵称和头像，需要用户完善信息
          nickname: isFirstLogin ? '' : '微信用户',
          avatar: isFirstLogin ? '' : '/static/default-avatar.png',
          // 如果有 encryptedData，模拟后端解密后获取的手机号
          phone: params.encryptedData ? '13800138000' : mockUser.phone
        }
      })
    }, 1000)
  })
}
```

**关键点：**
- 当有 `encryptedData` 时，认为是首次登录
- 返回空的 `nickname` 和 `avatar`
- 触发完善信息流程

### 2. 登录后检查逻辑

**文件：** `miniprogram/pages/auth/login.vue:462-489`

```typescript
// 保存登录信息
saveLoginInfo(result.token, result.refreshToken, result.user)

// 检查用户信息是否完整（头像和昵称）
const needCompleteInfo = !result.user.nickname || !result.user.avatar

if (needCompleteInfo) {
  // 需要完善信息，跳转到完善信息页面
  console.log('[微信登录] 需要完善用户信息')
  uni.showToast({
    title: '登录成功',
    icon: 'success',
    duration: 1500
  })

  setTimeout(() => {
    uni.redirectTo({
      url: '/pages/profile/complete-info?from=login'
    })
  }, 1500)
} else {
  // 信息完整，直接跳转首页
  uni.showToast({
    title: '登录成功',
    icon: 'success'
  })

  setTimeout(() => {
    handleLoginSuccess()
  }, 1500)
}
```

**关键点：**
- 检查 `nickname` 和 `avatar` 是否为空
- 为空则跳转到完善信息页面
- 不为空则直接跳转首页

### 3. 跳过功能逻辑

**文件：** `miniprogram/pages/profile/complete-info.vue:301-357`

```typescript
const handleSkip = async () => {
  try {
    loading.value = true

    // 生成随机编号（100-999）
    const randomNum = Math.floor(Math.random() * 900) + 100
    const defaultNickname = `叨叨车友${randomNum}`
    const defaultAvatar = '/static/logo.png'

    console.log('[跳过完善信息] 生成默认信息:', { defaultNickname, defaultAvatar })

    // 调用后端API保存默认信息
    const result = await updateUserProfile({
      nickname: defaultNickname,
      avatar: defaultAvatar,
      gender: 0
    })

    // 更新本地缓存
    const updatedUserInfo = {
      ...parsed,
      nickname: defaultNickname,
      avatar: defaultAvatar,
      gender: 0
    }
    uni.setStorageSync('userInfo', updatedUserInfo)

    console.log('[跳过完善信息] 保存成功，跳转首页')

    uni.showToast({
      title: '已使用默认信息',
      icon: 'success',
      duration: 1500
    })

    // 跳转到首页
    setTimeout(() => {
      uni.switchTab({
        url: '/pages/index/index'
      })
    }, 1500)
  } catch (error: any) {
    console.error('[跳过完善信息] 保存失败:', error)
    uni.showToast({
      title: error.message || '操作失败',
      icon: 'none'
    })
  } finally {
    loading.value = false
  }
}
```

**关键点：**
- 生成随机3位数编号（100-999）
- 组合成默认昵称：`叨叨车友XXX`
- 使用叨叨房车logo作为默认头像
- 调用API保存
- 更新本地缓存
- 跳转首页

---

## 预期日志输出

### 完整流程日志

```
// 1. 页面加载
[登录页面] 当前平台: weixin 支持一键登录: true

// 2. 点击登录按钮
[微信手机号授权] 回调事件: {type: "getphonenumber", ...}

// 3. 获取登录凭证
[微信登录] 获取code成功: 0b3iGKFa1qTdOK0pXuFa1veUv13iGKF7
[微信手机号] 获取手机号code成功: 032f1ff67780c0293a4beddc53635c98...

// 4. 调用登录API
[Mock] 微信授权登录: {
  code: "0b3iGKFa1qTdOK0pXuFa1veUv13iGKF7",
  encryptedData: "TMYWirw27YQfdL1Fx66alHeW9WOiDqaFWEe8jBnwe9eX...",
  iv: "/mxCSMBIXJgJtkxOxjvl9Q=="
}

// 5. 保存登录信息
[Auth] 登录信息已保存

// 6. 检查用户信息（关键）
[微信登录] 需要完善用户信息  ← 这条日志必须出现

// 7. 跳转到完善信息页面
// （页面自动跳转，无日志）

// 8. 如果选择跳过
[跳过完善信息] 生成默认信息: {
  defaultNickname: "叨叨车友123",
  defaultAvatar: "/static/logo.png"
}
[Mock] 更新用户资料: {
  nickname: "叨叨车友123",
  avatar: "/static/logo.png",
  gender: 0
}
[跳过完善信息] 保存成功，跳转首页
```

---

## 常见问题排查

### Q1: 登录后没有跳转到完善信息页面

**原因：** Mock 数据返回了非空的昵称和头像

**解决方法：**
1. 检查 `api/auth.ts` 中的 `wechatLogin` 函数
2. 确认 `isFirstLogin` 逻辑正确
3. 确认返回的 `nickname` 和 `avatar` 为空字符串

**验证方法：**
```javascript
// 在登录成功后添加日志
console.log('[调试] 用户信息:', result.user)
console.log('[调试] nickname:', result.user.nickname)
console.log('[调试] avatar:', result.user.avatar)
console.log('[调试] needCompleteInfo:', needCompleteInfo)
```

### Q2: 点击跳过按钮没有反应

**原因：** 可能是 loading 状态或按钮禁用

**解决方法：**
1. 检查按钮是否被禁用
2. 查看控制台是否有错误日志
3. 确认 `updateUserProfile` API 是否正常

**验证方法：**
```javascript
// 在 handleSkip 函数开始处添加日志
console.log('[调试] 点击跳过按钮')
console.log('[调试] loading:', loading.value)
console.log('[调试] canSkip:', canSkip.value)
```

### Q3: 默认昵称没有生成

**原因：** 随机数生成逻辑错误

**解决方法：**
1. 检查 `Math.floor(Math.random() * 900) + 100` 逻辑
2. 确认生成的编号在 100-999 范围内

**验证方法：**
```javascript
// 测试随机数生成
for (let i = 0; i < 10; i++) {
  const randomNum = Math.floor(Math.random() * 900) + 100
  console.log('随机编号:', randomNum)
}
// 预期输出：100-999 之间的随机数
```

---

## 测试检查清单

### 功能测试

- [ ] 微信一键登录按钮显示正常
- [ ] 点击按钮触发手机号授权
- [ ] 授权成功获取 code、encryptedData、iv
- [ ] 调用登录API成功
- [ ] 保存登录信息成功
- [ ] 检查用户信息完整性
- [ ] 首次登录跳转到完善信息页面
- [ ] 完善信息页面显示正常
- [ ] 头像选择功能正常
- [ ] 昵称输入功能正常
- [ ] 性别选择功能正常
- [ ] 保存按钮功能正常
- [ ] 跳过按钮显示正常
- [ ] 跳过功能生成默认信息
- [ ] 默认昵称格式正确（叨叨车友XXX）
- [ ] 默认头像使用logo
- [ ] 保存成功后跳转首页
- [ ] 已有信息用户直接跳转首页

### 日志测试

- [ ] 所有关键步骤都有日志输出
- [ ] 日志信息清晰易懂
- [ ] 错误日志包含详细信息
- [ ] 成功日志包含必要数据

### 用户体验测试

- [ ] 按钮文案清晰
- [ ] 提示信息友好
- [ ] 加载状态显示正常
- [ ] 防止重复操作
- [ ] 跳转流畅无卡顿

---

## 测试报告模板

### 测试信息

- **测试日期：** 2025-12-12
- **测试人员：** [姓名]
- **测试环境：** 微信开发者工具
- **测试版本：** v1.0.0

### 测试结果

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 微信一键登录 | 成功获取手机号 | ✅ 成功 | 通过 |
| 首次登录跳转 | 跳转到完善信息页面 | ✅ 成功 | 通过 |
| 完善信息功能 | 可以选择头像和输入昵称 | ✅ 成功 | 通过 |
| 跳过功能 | 生成默认信息并跳转首页 | ✅ 成功 | 通过 |
| 默认昵称生成 | 格式为"叨叨车友XXX" | ✅ 成功 | 通过 |
| 已有信息用户 | 直接跳转首页 | ✅ 成功 | 通过 |

### 发现的问题

1. **问题描述：** [描述问题]
   - **严重程度：** 高/中/低
   - **复现步骤：** [步骤]
   - **预期结果：** [预期]
   - **实际结果：** [实际]
   - **截图：** [如有]

### 测试结论

- [ ] 通过
- [ ] 不通过
- [ ] 部分通过

### 备注

[其他说明]

---

## 总结

本测试指南涵盖了微信一键登录的完整测试流程，包括：

1. **首次登录流程**：手机号授权 → 登录 → 完善信息 → 首页
2. **跳过流程**：手机号授权 → 登录 → 跳过 → 默认信息 → 首页
3. **已有信息用户**：手机号授权 → 登录 → 直接首页

所有功能都已实现并可以测试。请按照本指南进行完整的测试，确保所有功能正常工作。
